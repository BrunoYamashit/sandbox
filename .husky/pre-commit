#!/usr/bin/env sh

echo "========================================"
echo "Running pre-commit checks..."
echo "========================================"

# 9. No Direct Commits to Main/Master
echo ""
echo "[1/9] Checking branch protection..."
branch="$(git rev-parse --abbrev-ref HEAD)"
if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
  echo "X Direct commits to main/master are not allowed."
  echo "X Please create a feature branch."
  exit 1
fi
echo "√ Branch check passed"

# 8. Branch Name Validation
echo ""
echo "[2/9] Validating branch name..."
if ! echo "$branch" | grep -qE '^(feature|bugfix|hotfix|release)\/[a-z0-9._-]+$'; then
  echo "X Invalid branch name: $branch"
  echo "X Use format: feature/*, bugfix/*, hotfix/*, or release/*"
  echo "X Example: feature/add-login or bugfix/fix-header"
  exit 1
fi
echo "√ Branch name is valid: $branch"

# 5. No Console Logs Check
echo ""
echo "[3/9] Checking for console.log statements..."
if git diff --cached --name-only | grep -E '\.(js|jsx|ts|tsx)$' | xargs grep -n 'console\.log' 2>/dev/null; then
  echo "X Found console.log statements. Please remove them before committing."
  exit 1
fi
echo "√ No console.log statements found"

# 4. Commit Message Validation (prepare for commit-msg hook)
echo ""
echo "[4/9] Preparing commit message validation..."
echo "√ Commit message will be validated"

# 3. Staged Files Only with lint-staged
echo ""
echo "[5/9] Running lint-staged on changed files..."
pnpm exec lint-staged || {
  echo "X Lint-staged checks failed."
  exit 1
}
echo "√ Lint-staged checks passed"

# 2. TypeScript Type Checking
echo ""
echo "[6/9] Running TypeScript type check..."
pnpm run type-check || {
  echo "X Type checking failed. Please fix type errors."
  exit 1
}
echo "√ Type checking passed"

# 1. Linting (ESLint)
echo ""
echo "[7/9] Running ESLint..."
pnpm run lint || {
  echo "X Linting failed. Run 'pnpm run lint:fix' to auto-fix issues."
  exit 1
}
echo "√ ESLint passed"

# Prettier - Format check
echo ""
echo "[8/9] Checking code formatting with Prettier..."
pnpm run prettier:check || {
  echo "X Prettier check failed. Run 'pnpm run prettier:write' to fix formatting."
  exit 1
}
echo "√ Prettier check passed"

# Run tests
echo ""
echo "[9/9] Running tests..."
pnpm test -- --passWithNoTests || {
  echo "X Tests failed. Please fix failing tests before committing."
  exit 1
}
echo "√ All tests passed"

echo ""
echo "========================================"
echo "√ All pre-commit checks passed!"
echo "========================================"