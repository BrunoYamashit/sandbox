#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}========================================${NC}"
echo "${BLUE}Running pre-commit checks...${NC}"
echo "${BLUE}========================================${NC}"

# 9. No Direct Commits to Main/Master
echo "\n${YELLOW}[1/9] Checking branch protection...${NC}"
branch="$(git rev-parse --abbrev-ref HEAD)"
if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
  echo "${RED}‚ùå Direct commits to main/master are not allowed.${NC}"
  echo "${RED}Please create a feature branch.${NC}"
  exit 1
fi
echo "${GREEN}‚úì Branch check passed${NC}"

# 8. Branch Name Validation
echo "\n${YELLOW}[2/9] Validating branch name...${NC}"
if ! echo "$branch" | grep -qE '^(feature|bugfix|hotfix|release)\/[a-z0-9._-]+$'; then
  echo "${RED}‚ùå Invalid branch name: $branch${NC}"
  echo "${RED}Use format: feature/*, bugfix/*, hotfix/*, or release/*${NC}"
  echo "${RED}Example: feature/add-login or bugfix/fix-header${NC}"
  exit 1
fi
echo "${GREEN}‚úì Branch name is valid: $branch${NC}"

# 5. No Console Logs Check
echo "\n${YELLOW}[3/9] Checking for console.log statements...${NC}"
if git diff --cached --name-only | grep -E '\.(js|jsx|ts|tsx)$' | xargs grep -n 'console\.log' 2>/dev/null; then
  echo "${RED}‚ùå Found console.log statements. Please remove them before committing.${NC}"
  exit 1
fi
echo "${GREEN}‚úì No console.log statements found${NC}"

# 4. Commit Message Validation (prepare for commit-msg hook)
echo "\n${YELLOW}[4/9] Preparing commit message validation...${NC}"
echo "${GREEN}‚úì Commit message will be validated${NC}"

# 3. Staged Files Only with lint-staged
echo "\n${YELLOW}[5/9] Running lint-staged on changed files...${NC}"
pnpm exec lint-staged || {
  echo "${RED}‚ùå Lint-staged checks failed.${NC}"
  exit 1
}
echo "${GREEN}‚úì Lint-staged checks passed${NC}"

# 2. TypeScript Type Checking
echo "\n${YELLOW}[6/9] Running TypeScript type check...${NC}"
pnpm run type-check || {
  echo "${RED}‚ùå Type checking failed. Please fix type errors.${NC}"
  exit 1
}
echo "${GREEN}‚úì Type checking passed${NC}"

# 1. Linting (ESLint)
echo "\n${YELLOW}[7/9] Running ESLint...${NC}"
pnpm run lint || {
  echo "${RED}‚ùå Linting failed. Run 'pnpm run lint:fix' to auto-fix issues.${NC}"
  exit 1
}
echo "${GREEN}‚úì ESLint passed${NC}"

# Prettier - Format check
echo "\n${YELLOW}[8/9] Checking code formatting with Prettier...${NC}"
pnpm run prettier:check || {
  echo "${RED}‚ùå Prettier check failed. Run 'pnpm run prettier:write' to fix formatting.${NC}"
  exit 1
}
echo "${GREEN}‚úì Prettier check passed${NC}"

# Run tests
echo "\n${YELLOW}[9/9] Running tests...${NC}"
pnpm test -- --passWithNoTests || {
  echo "${RED}‚ùå Tests failed. Please fix failing tests before committing.${NC}"
  exit 1
}
echo "${GREEN}‚úì All tests passed${NC}"

echo "\n${BLUE}========================================${NC}"
echo "${GREEN}‚úì All pre-commit checks passed! üéâ${NC}"
echo "${BLUE}========================================${NC}"